---
title: 에이전트 메시지에서 파일 및 이미지 사용하기
sidebar_label: "파일"
sidebar_position: 1000
description: "에이전트 컴포넌트에서 이미지와 파일 작업하기"
---

LLM이 메시지에서 참조할 수 있도록 이미지와 파일을 추가할 수 있습니다.

참고: LLM에 URL을 전송하는 것은 클라우드 백엔드에서 훨씬 쉽습니다. 공개적으로 사용 가능한 스토리지 URL을 제공하기 때문입니다. 로컬에서 개발하려면 `ngrok`와 같은 도구를 사용하여 트래픽을 프록시할 수 있습니다.

예제 코드:

- [files/autoSave.ts](https://github.com/get-convex/agent/blob/main/example/convex/files/autoSave.ts)
  자동 파일 저장 사용 방법의 간단한 예제가 있습니다.
- [files/addFile.ts](https://github.com/get-convex/agent/blob/main/example/convex/files/addFile.ts)
  파일을 저장하고, 질문을 제출하고, 응답을 생성하는 단계를 분리한 예제가 있습니다.
- [files/generateImage.ts](https://github.com/get-convex/agent/blob/main/example/convex/files/generateImage.ts)
  이미지를 생성하고 어시스턴트 메시지에 저장하는 예제가 있습니다.
- [FilesImages.tsx](https://github.com/get-convex/agent/blob/main/example/ui/files/FilesImages.tsx)
  클라이언트 측 코드가 있습니다.

## 예제 실행하기

```sh
git clone https://github.com/get-convex/agent.git
cd agent
npm run setup
npm run example
```

## 먼저 업로드하고 비동기로 생성하여 이미지 보내기

표준 접근 방식은 다음과 같습니다:

1. 데이터베이스에 파일 업로드 (`uploadFile` 액션). 참고: 편의에 따라 일반 액션 또는 httpAction에서 수행할 수 있습니다.
2. 스레드에 메시지 전송 (`submitFileQuestion` 액션)
3. LLM에 파일을 전송하여 비동기로 텍스트 생성/스트리밍 (`generateResponse` 액션)
4. 스레드에서 메시지 쿼리 (`listThreadMessages` 쿼리)

근거:

mutation에서 액션보다 메시지를 제출하는 것이 더 좋습니다. 클라이언트 측에서 optimistic update를 사용하여 전송된 메시지를 즉시 표시하고, 쿼리에서 메시지가 내려올 때 정확히 사라지게 할 수 있기 때문입니다.

그러나 mutation에서 파일 스토리지에 저장할 수 없으므로 파일이 이미 존재해야 합니다(따라서 fileId).

그런 다음 클라이언트를 대기시키지 않고 비동기로 응답을 생성할 수 있습니다(재시도 등 포함).

### 1: 파일 저장하기

```ts
import { storeFile } from "@convex-dev/agent";
import { components } from "./_generated/api";

const { file } = await storeFile(
  ctx,
  components.agent,
  new Blob([bytes], { type: mimeType }),
  {
    filename,
    sha256,
  },
);
const { fileId, url, storageId } = file;
```

### 2: 메시지 전송하기

```ts
// in your mutation
const { filePart, imagePart } = await getFile(ctx, components.agent, fileId);
const { messageId } = await fileAgent.saveMessage(ctx, {
  threadId,
  message: {
    role: "user",
    content: [
      imagePart ?? filePart, // if it's an image, prefer that kind.
      { type: "text", text: "What is this image?" },
    ],
  },
  metadata: { fileIds: [fileId] }, // IMPORTANT: this tracks the file usage.
});
```

### 3: 응답 생성 및 응답 쿼리하기

이것은 텍스트 입력과 동일한 방식으로 수행됩니다.

```ts
// in an action
await thread.generateText({ promptMessageId: messageId });
```

```ts
// in a query
const messages = await agent.listMessages(ctx, { threadId, paginationOpts });
```

## 인라인 저장 방식

액션 내에서 텍스트를 생성할 때 이미지/파일을 직접 전달할 수도 있습니다. `message` 인자에 전달된 모든 이미지나 파일은 64k보다 크면 자동으로 파일 스토리지에 저장되며, fileId가 메시지에 저장됩니다.

예제:

```ts
await thread.generateText({
  message: {
    role: "user",
    content: [
      { type: "image", image: imageBytes, mimeType: "image/png" },
      { type: "text", text: "What is this image?" },
    ],
  },
});
```

## 내부 동작 원리

파일 저장에는 3가지 구성 요소가 있습니다:

1. 파일 스토리지에 저장(컴포넌트 스토리지가 아닌 앱에서). 즉, `storageId`로 직접 액세스하고 URL을 생성할 수 있습니다.
2. 컴포넌트에 파일 참조(storageId) 저장. 파일을 참조하는 메시지 수를 자동으로 추적하므로 더 이상 사용되지 않는 파일을 정리할 수 있습니다([files/vacuum.ts](https://github.com/get-convex/agent/blob/main/example/convex/files/vacuum.ts) 참조).
3. LLM에 전송된 메시지에서 데이터 대신 URL을 삽입하고, mimeType 및 기타 제공된 메타데이터와 함께 포함합니다. 제공되지 않은 경우 [`guessMimeType`](https://github.com/get-convex/agent/blob/main/src/mapping.ts#L556)에서 추론됩니다.

### 파일을 직접 저장하고 URL을 전달할 수 있나요?

예! LLM에 이미지나 파일 대신 항상 URL을 전달할 수 있습니다.

```ts
const storageId = await ctx.storage.store(blob);
const url = await ctx.storage.getUrl(storageId);

await thread.generateText({
  message: {
    role: "user",
    content: [
      { type: "image", data: url, mimeType: blob.type },
      { type: "text", text: "What is this image?" },
    ],
  },
});
```

## 이미지 생성하기

[files/generateImage.ts](https://github.com/get-convex/agent/blob/main/example/convex/files/generateImage.ts)에 프롬프트를 받아 OpenAI의 dall-e 2로 이미지를 생성한 다음, 스레드에 이미지를 저장하는 예제가 있습니다.

다음과 같이 시도해 볼 수 있습니다:

```sh
npx convex run files:generateImage:replyWithImage '{prompt: "make a picture of a cat" }'
```
