---
title: 스레드
sidebar_label: "스레드"
sidebar_position: 200
description: "대화 기록에서 메시지를 그룹화하기"
---

스레드는 메시지를 선형 기록으로 그룹화하는 방법입니다. 에이전트 컴포넌트에 저장된 모든 메시지는 스레드와 연결됩니다. 프롬프트를 기반으로 메시지가 생성되면 사용자 메시지와 생성된 에이전트 메시지를 자동으로 저장합니다.

스레드는 사용자와 연결될 수 있으며, 메시지는 각각 개별적으로 사용자와 연결될 수 있습니다. 기본적으로 메시지는 스레드의 사용자와 연결됩니다.

## 스레드 생성하기

mutation 또는 액션에서 스레드를 생성할 수 있습니다. 액션에서 생성하면 `thread`도 반환되며(아래 참조) LLM 호출을 시작하고 메시지를 생성할 수 있습니다. userId를 지정하면 스레드가 해당 사용자와 연결되고 메시지가 사용자의 기록에 저장됩니다.

```ts
import { createThread } from "@convex-dev/agent";

const threadId = await createThread(ctx, components.agent);
```

스레드에 설정할 메타데이터를 전달할 수도 있습니다:

```ts
const userId = await getAuthUserId(ctx);
const threadId = await createThread(ctx, components.agent, {
  userId,
  title: "My thread",
  summary: "This is a summary of the thread",
});
```

메타데이터는 향후 에이전트에게 컨텍스트로 자동 제공될 수 있지만, 현재로서는 [플레이그라운드](./playground.mdx)에서 스레드를 구성하는 데 도움이 되는 편의 기능입니다.

## 스레드에서 메시지 생성하기

에이전트 함수 `agent.generateText`, `agent.generateObject`, `agent.streamText`, `agent.streamObject`를 통해 스레드에서 메시지를 생성할 수 있습니다. 모든 에이전트는 다른 에이전트가 생성한 스레드에서 메시지를 생성할 수 있습니다.

```ts
const agent = new Agent(components.agent, { languageModel, instructions });

export const generateReplyToPrompt = action({
  args: { prompt: v.string(), threadId: v.string() },
  handler: async (ctx, { prompt, threadId }) => {
    // await authorizeThreadAccess(ctx, threadId);
    const result = await agent.generateText(ctx, { threadId }, { prompt });
    return result.text;
  },
});
```

메시지 생성 및 저장에 대한 자세한 내용은 [메시지](./messages.mdx)를 참조하세요.

## `agent.continueThread`의 `thread` 객체를 사용하여 스레드 계속하기

액션 내에서 `agent.createThread` 또는 `agent.continueThread`를 호출하여 에이전트별 `thread` 객체를 생성하여 스레드를 계속할 수도 있습니다. 이렇게 하면 매번 해당 매개변수를 지정하지 않고 메서드를 호출할 수 있습니다.

```ts
const { thread } = await agent.continueThread(ctx, { threadId });
const result = await thread.generateText({ prompt });
```

`continueThread` 또는 `createThread`의 `thread`(액션에서만 사용 가능)는 스레드별 편의 메서드가 있는 `Thread` 객체입니다:

- `thread.getMetadata()` - `userId`, `title`, `summary` 등을 가져옵니다.
- `thread.updateMetadata({ patch: { title, summary, userId} })` - 메타데이터를 업데이트합니다.
- `thread.generateText({ prompt, ... })` - `agent.generateText(ctx, { threadId }, { prompt, ... })`와 동일
- `thread.streamText({ prompt, ... })` - `agent.streamText(ctx, { threadId }, { prompt, ... })`와 동일
- `thread.generateObject({ prompt, ... })` - `agent.generateObject(ctx, { threadId }, { prompt, ... })`와 동일
- `thread.streamObject({ prompt, ... })` - `agent.streamObject(ctx, { threadId }, { prompt, ... })`와 동일

메시지 생성에 대한 자세한 내용은 [메시지 문서](./messages.mdx)를 참조하세요.

## 스레드 삭제하기

`threadId`로 스레드를 삭제할 수 있습니다.

비동기(mutation 또는 액션에서):

```ts
await agent.deleteThreadAsync(ctx, { threadId });
```

배치로 동기(액션에서):

```ts
await agent.deleteThreadSync(ctx, { threadId });
```

`userId`로 사용자의 모든 스레드를 삭제할 수도 있습니다.

```ts
await agent.deleteThreadsByUserId(ctx, { userId });
```

## 사용자가 소유한 모든 스레드 가져오기

```ts
const threads = await ctx.runQuery(
  components.agent.threads.listThreadsByUserId,
  { userId, paginationOpts: args.paginationOpts },
);
```

## 사용자와 연결된 모든 스레드 및 메시지 삭제하기

비동기(mutation 또는 액션에서):

```ts
await ctx.runMutation(components.agent.users.deleteAllForUserIdAsync, {
  userId,
});
```

동기(액션에서):

```ts
await ctx.runMutation(components.agent.users.deleteAllForUserId, { userId });
```

## 스레드에서 메시지 가져오기

자세한 내용은 [messages.mdx](./messages.mdx)를 참조하세요.

```ts
import { listMessages } from "@convex-dev/agent";

const messages = await listMessages(ctx, components.agent, {
  threadId,
  excludeToolMessages: true,
  paginationOpts: { cursor: null, numItems: 10 }, // null means start from the beginning
});
```

또는 UIMessage 타입의 경우(UI 렌더링에 더 쉬움):

```ts
import { listUIMessages } from "@convex-dev/agent";

const messages = await listUIMessages(ctx, components.agent, {
  threadId,
  paginationOpts: { cursor: null, numItems: 10 },
});
```
