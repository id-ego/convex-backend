---
title: "Convex와 TanStack Query"
sidebar_label: "TanStack Query"
description:
  "고급 데이터 페칭 패턴을 위해 Convex를 TanStack Query와 통합하기"
---

import Setup from "!!raw-loader!@site/../demos/react-query/src/main.tsx";
import App from "!!raw-loader!@site/../demos/react-query/src/App.tsx";

[TanStack Query](https://tanstack.com/query/latest)는 서버 요청 관리를 위한 뛰어나고 인기 있는 라이브러리입니다.

[`@convex-dev/react-query`](https://www.npmjs.com/package/@convex-dev/react-query) 라이브러리는 TanStack Query와 함께 사용할 수 있는 [Query Option](https://tanstack.com/query/latest/docs/framework/react/guides/query-options) 함수를 제공합니다.

표준 [Convex React 클라이언트](/client/react)의 모든 기능이 TanStack Query API를 통해 사용 가능한 것은 아니지만 두 가지를 함께 사용하여 필요에 따라 표준 Convex React 훅으로 전환할 수 있습니다.

<BetaAdmonition feature="TanStack Query 어댑터" verb="는" />

이렇게 하면 TanStack Query `useQuery` 훅을 사용하여 Convex 쿼리 함수를 구독하는 것이 다음과 같이 보입니다:

```ts
const { data, isPending, error } = useQuery(convexQuery(api.messages.list, {}));
```

TanStack Query와 함께 사용되는 API 엔드포인트의 일반적인 폴링 패턴 대신 위의 코드는 Convex 서버에서 이 `api.messages.list` 쿼리에 대한 업데이트를 반응적으로 수신합니다. 모든 관련 구독에 대한 새 결과가 클라이언트에 푸시되어 동시에 업데이트되므로 데이터가 절대 오래되지 않으며 쿼리를 수동으로 무효화할 필요가 없습니다.

<Admonition type="note" title="다른 프레임워크 지원">
  현재 [`@convex-dev/react-query`](https://www.npmjs.com/package/@convex-dev/react-query)를 통해 [React
  Query](https://tanstack.com/query/latest/docs/framework/react/overview)만 지원됩니다.
  vue-query, svelte-query, solid-query 또는 angular-query에 대한 지원이 도움이 될지 [알려주세요](https://convex.dev/community).
</Admonition>

## 설정

TanStack Query에서 실시간 업데이트를 받으려면 `ConvexQueryClient`를 생성하고 TanStack Query [QueryClient](https://tanstack.com/query/latest/docs/reference/QueryClient)에 연결하세요. 다음과 같이 어댑터 라이브러리를 설치한 후

```
npm i @convex-dev/react-query
```

다음과 같이 Convex를 TanStack Query에 연결하세요:

<Snippet
  title="src/main.tsx"
  source={Setup}
  highlightPatterns={["QueryClient", "convexQuery"]}
/>

React 트리를 생성할 때 다음 두 가지를 모두 수행해야 합니다:

- [TanStack Query 훅](https://tanstack.com/query/latest/docs/framework/react/reference/useQuery)을 사용할 수 있도록 앱을 TanStack Query [`QueryClientProvider`](https://tanstack.com/query/latest/docs/framework/react/reference/QueryClientProvider)로 래핑하고
- 일반 [Convex React](/client/react) 훅을 사용할 수 있도록 앱을 [`ConvexProvider`](/api/modules/react#convexprovider)로 래핑합니다

## 쿼리

Convex [쿼리](/functions/query-functions.mdx)에 대한 실시간 업데이트 구독은 `convexQuery`와 함께 TanStack [`useQuery`](https://tanstack.com/query/latest/docs/framework/react/reference/useQuery)를 호출하는 것만큼 간단합니다:

```ts
import { useQuery } from "@tanstack/react-query";
import { convexQuery } from "@convex-dev/react-query";
import { api } from "../convex/_generated/api";

export function App() {
  const { data, isPending, error } = useQuery(
    convexQuery(api.functions.myQuery, { id: 123 }),
  );
  return isPending ? "Loading..." : data;
}
```

`convexQuery`에서 반환된 객체를 추가 [`useQuery` 인수](https://tanstack.com/query/latest/docs/framework/react/reference/useQuery)를 지정하는 객체에 펼칠 수 있습니다.

```ts
const { data, isPending, error } = useQuery({
  ...convexQuery(api.functions.myQuery, { id: 123 }),
  initialData: [], // 데이터를 사용할 수 없는 경우 빈 목록 사용
  gcTime: 10000, // 이 컴포넌트가 마운트 해제된 후 10초 동안 구독 유지
});
```

## 뮤테이션

앱은 TanStack [`useMutation`](https://tanstack.com/query/latest/docs/framework/react/reference/useMutation) 훅을 사용하고 `mutationFn` 속성을 `useConvexMutation` 호출 결과로 설정하여 Convex [뮤테이션](/functions/mutation-functions.mdx)을 호출할 수 있습니다:

```ts
import { useMutation } from "@tanstack/react-query";
import { useConvexMutation } from "@convex-dev/react-query";
import { api } from "../convex/_generated/api";

export function App() {
  const { mutate, isPending } = useMutation({
    mutationFn: useConvexMutation(api.functions.doSomething),
  });
  return <button onClick={() => mutate({a: "Hello"})}>Click me</button>;
}
```

`useConvexMutation`은 [Convex React](/client/react)의 [`useMutation`](/client/react#editing-data) 훅을 다시 내보낸 것일 뿐입니다.

## TanStack Query에서 `fetch` 사용과의 차이점

Convex는 React Query로 데이터를 가져오는 다른 방법보다 더 강력한 보장을 제공하므로 일부 옵션 및 반환 값 속성이 더 이상 필요하지 않습니다.

Convex 쿼리 구독은 주어진 함수에 대해 `useQuery`를 사용하는 마지막 컴포넌트가 마운트 해제된 후 `gcTime` 밀리초 동안 활성 상태로 유지됩니다. 이 값은 기본적으로 5분입니다. 이로 인해 원하지 않는 함수 활동이 발생하면 더 작은 값을 사용하세요.

Convex에서 제공하는 데이터는 절대 오래되지 않으므로 `useQuery` 반환 값의 `isStale` 속성은 항상 false입니다. Convex가 WebSocket 프로토콜을 통해 자체 재시도 메커니즘을 제공하므로 `retry` 관련 옵션은 무시됩니다. Convex 쿼리는 항상 최신 상태이므로 `refetch` 관련 옵션도 마찬가지로 무시됩니다.
