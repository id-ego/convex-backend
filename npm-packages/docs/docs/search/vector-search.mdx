---
title: "벡터 검색"
sidebar_position: 100
description: "임베딩에서 벡터 검색 쿼리 실행하기"
slug: "vector-search"
---

import Schema from "!!raw-loader!@site/../demos/vector-search/convex/schema.ts";
import VectorSearchSnippets from "!!raw-loader!@site/../private-demos/snippets/convex/vectorSearch.ts";
import Foods from "!!raw-loader!@site/../private-demos/snippets/convex/foods.ts";
import VectorSearchSnippets2 from "!!raw-loader!@site/../private-demos/snippets/convex/vectorSearch2.ts";
import Movies from "!!raw-loader!@site/../demos/vector-search/convex/movies.ts";

벡터 검색을 사용하면 제공된 벡터와 유사한 Convex 문서를 찾을 수 있습니다.
일반적으로 벡터는 텍스트, 이미지 또는 오디오의 숫자 표현인 임베딩입니다.

임베딩과 벡터 검색을 사용하면 AI 기반 애플리케이션을 위한 유용한 컨텍스트를 LLM에 제공하고, 유사한 콘텐츠에 대한 추천 등을 할 수 있습니다.

벡터 검색은 일관성 있고 완전히 최신 상태입니다. 벡터를 작성하고 벡터 검색에서 즉시 읽을 수 있습니다. 그러나
[전체 텍스트 검색](/search.mdx)과 달리 벡터 검색은 [Convex 액션](/functions/actions.mdx)에서만 사용할 수 있습니다.

**예제:**
[벡터 검색 앱](https://github.com/get-convex/convex-demos/tree/main/vector-search)

벡터 검색을 사용하려면 다음이 필요합니다:

1. 벡터 인덱스 정의하기.
1. [액션](/functions/actions.mdx) 내에서 벡터 검색 실행하기.

## 벡터 인덱스 정의하기

[데이터베이스 인덱스](/database/reading-data/indexes/indexes.md)와 마찬가지로, 벡터 인덱스는 효율적인 쿼리를 가능하게 하기 위해 미리 구축되는 데이터 구조입니다. 벡터 인덱스는 Convex [스키마](/database/schemas.mdx)의 일부로 정의됩니다.

테이블에 벡터 인덱스를 추가하려면 테이블 스키마에서 [`vectorIndex`](/api/classes/server.TableDefinition#vectorindex) 메서드를 사용하세요. 모든 벡터 인덱스는 고유한 이름과 다음을 포함하는 정의를 가집니다:

1. `vectorField` 문자열
   - 벡터 검색을 위해 인덱싱된 필드의 이름입니다.
2. `dimensions` 숫자
   - 벡터 인덱스의 고정 크기입니다. 임베딩을 사용하는 경우, 이 차원은 임베딩의 크기와 일치해야 합니다(예: OpenAI의 경우 `1536`).
3. [선택사항] `filterFields` 배열
   - 벡터 인덱스 내에서 빠른 필터링을 위해 인덱싱되는 추가 필드의 이름입니다.
4. [선택사항] `staged` 불리언
   - `true`로 설정하면,
     [단계별 데이터베이스 인덱스](/database/reading-data/indexes#staged-indexes)와 유사하게 배포 시점부터 비동기적으로 인덱스가 백필됩니다.
     이는 인덱스 백필 시간이 중요한 대형 테이블에 유용합니다. 기본값은 `false`입니다.

예를 들어, 주어진 요리 내에서 유사한 음식을 검색할 수 있는 인덱스를 원하는 경우, 테이블 정의는 다음과 같습니다:

<Snippet
  source={Schema}
  title="convex/schema.ts"
  snippet="schemaOneTable"
  highlightPatterns={["vectorIndex"]}
/>

`properties.name`과 같은 점으로 구분된 경로를 사용하여 중첩된 문서에 벡터 및 필터 필드를 지정할 수 있습니다.

## 벡터 검색 실행하기

데이터베이스 쿼리나 전체 텍스트 검색과 달리, 벡터 검색은 [Convex 액션](/functions/actions.mdx)에서만 수행할 수 있습니다.

일반적으로 세 단계가 포함됩니다:

1. 제공된 입력에서 벡터 생성하기(예: OpenAI 사용)
1. [`ctx.vectorSearch`](/api/interfaces/server.GenericActionCtx#vectorsearch)를 사용하여 유사한 문서의 ID 가져오기
1. 문서에 대한 원하는 정보 로드하기

다음은 설명을 기반으로 유사한 프랑스 음식을 검색하는 처음 두 단계의 예입니다:

<TSAndJSSnippet
  sourceTS={VectorSearchSnippets}
  sourceJS={VectorSearchSnippets}
  title="convex/foods.ts"
  snippet="vectorSearchQuery"
  highlightPatterns={["vectorSearch"]}
/>

첫 번째 단계의 예는 벡터 검색 데모 앱의
[여기](https://github.com/get-convex/convex-demos/blob/main/vector-search/convex/foods.ts#L18)에서 찾을 수 있습니다.

두 번째 단계에 초점을 맞추면, `vectorSearch` API는 테이블 이름, 인덱스 이름, 그리고 마지막으로 검색을 설명하는 [`VectorSearchQuery`](/api/interfaces/server.VectorSearchQuery) 객체를 받습니다. 이 객체는 다음 필드를 가집니다:

1. `vector` 배열
   - 검색에 사용할 숫자 배열(예: 임베딩)입니다.
   - 검색은 가장 유사한 저장된 벡터를 가진 문서의 문서 ID를 반환합니다.
   - 인덱스의 `dimensions`와 동일한 길이여야 합니다.
2. [선택사항] `limit` 숫자
   - 반환받을 결과 수입니다. 지정된 경우, 이 값은 1에서 256 사이여야 합니다.
3. [선택사항] `filter`
   - 스키마의 `vectorIndex`에 있는 `filterFields`를 기반으로 결과 집합을 제한하는 표현식입니다. 자세한 내용은
     [필터 표현식](#filter-expressions)을 참조하세요.

정확히 두 개의 필드를 포함하는 객체의 `Array`를 반환합니다:

1. `_id`
   - 테이블에서 일치하는 문서의 [문서 ID](https://docs.convex.dev/database/document-ids)
2. `_score`
   - 검색하려는 벡터와 결과가 얼마나 유사한지를 나타내는 지표로, -1(가장 유사하지 않음)에서 1(가장 유사함) 범위입니다.

기본 문서나 벡터는 `results`에 포함되지 않으므로, 결과 목록을 얻은 후에는 결과에 대한 원하는 정보를 로드해야 합니다.

이 정보를 로드하는 몇 가지 전략이 [고급 패턴](#advanced-patterns) 섹션에 문서화되어 있습니다.

지금은 문서를 로드하고 액션에서 반환하겠습니다. 이를 위해 결과 목록을 Convex 쿼리에 전달하고 액션 내에서 실행하여 결과를 반환합니다:

<TSAndJSSnippet
  sourceTS={Foods}
  sourceJS={Foods}
  title="convex/foods.ts"
  snippet="fetchResults"
/>

<TSAndJSSnippet
  sourceTS={VectorSearchSnippets2}
  sourceJS={VectorSearchSnippets2}
  title="convex/foods.ts"
  snippet="fetchResults"
/>

### 필터 표현식

위에서 언급한 것처럼, 벡터 검색은 단일 필드에 대한 정확한 동등성 또는 표현식의 `OR`을 사용하여 문서의 추가 필드로 결과를 효율적으로 필터링하는 것을 지원합니다.

예를 들어, 다음은 요리가 정확히 "French"와 같은 음식에 대한 필터입니다:

<Snippet source={VectorSearchSnippets} snippet="filterSingleValue" />

`or` 표현식을 사용하여 여러 다른 값을 포함하는 단일 필드로 문서를 필터링할 수도 있습니다. 다음은 프랑스 또는 인도네시아 요리에 대한 필터입니다:

<Snippet source={VectorSearchSnippets} snippet="filterMultipleValues" />

여러 필터 필드가 있는 인덱스의 경우, 다른 필드에 `.or()` 필터를 사용할 수도 있습니다. 다음은 요리가 프랑스이거나 주 재료가 버터인 요리에 대한 필터입니다:

<Snippet source={VectorSearchSnippets} snippet="filterMultipleFields" />

**`cuisine`과 `mainIngredient` 모두 `.vectorIndex` 정의의 `filterFields`에 포함되어야 합니다.**

### 기타 필터링

결과는 액션에서 `_score` 필드를 사용하여 제공된 벡터와 얼마나 유사한지에 따라 필터링할 수 있습니다:

```ts
const results = await ctx.vectorSearch("foods", "by_embedding", {
  vector: embedding,
});
const filteredResults = results.filter((result) => result._score >= 0.9);
```

추가 필터링은 항상 벡터 검색 결과를 쿼리 또는 뮤테이션 함수에 전달하여 문서를 로드하고 문서의 필드를 사용하여 필터링을 수행할 수 있습니다.

**성능을 위해 가능한 한 많은 필터를 `.vectorSearch`에 넣으세요.**

### 정렬

벡터 쿼리는 항상 관련성 순서로 결과를 반환합니다.

현재 Convex는 [코사인 유사도](https://en.wikipedia.org/wiki/Cosine_similarity)를 기반으로 한 [근사 최근접 이웃 검색](https://en.wikipedia.org/wiki/Nearest_neighbor_search#Approximate_nearest_neighbor)을 사용하여 벡터를 검색합니다.
더 많은 유사도 메트릭에 대한 지원은
[향후 개발](#future-development)에서 제공될 예정입니다.

여러 문서가 동일한 점수를 가진 경우, 문서 ID로 순위가 결정됩니다.

## 고급 패턴

### 벡터를 저장하기 위한 별도의 테이블 사용

벡터 인덱스를 설정하는 두 가지 주요 옵션이 있습니다:

1. 다른 메타데이터와 동일한 테이블에 벡터 저장
1. 참조가 있는 별도의 테이블에 벡터 저장

위의 예는 첫 번째 옵션을 보여주며, 이는 더 간단하고 소량의 문서를 읽는 데 잘 작동합니다. 두 번째 옵션은 더 복잡하지만 대량의 문서를 읽거나 반환하는 것을 더 잘 지원합니다.

벡터는 일반적으로 크고 벡터 검색을 수행하는 것 이외에는 유용하지 않기 때문에, 다른 데이터를 읽을 때(예: `db.get()`) 데이터베이스에서 로드하거나 별도의 테이블에 저장하여 함수에서 반환하는 것을 피하는 것이 좋습니다.

영화에 대한 테이블 정의와 장르별로 필터링하여 유사한 영화를 검색하는 벡터 인덱스는 다음과 같습니다:

<Snippet source={Schema} title="convex/schema.ts" snippet="schemaTwoTables" />

임베딩을 생성하고 벡터 검색을 실행하는 것은 단일 테이블을 사용하는 것과 동일합니다. 벡터 검색 결과가 주어진 관련 문서를 로드하는 것은 `movieEmbeddings`에 대한 ID가 있지만 `movies` 문서를 로드하려고 하기 때문에 다릅니다. `movies` 테이블의 `by_embedding` 데이터베이스 인덱스를 사용하여 이를 수행할 수 있습니다:

<TSAndJSSnippet
  sourceTS={VectorSearchSnippets}
  sourceJS={VectorSearchSnippets}
  title="convex/movies.ts"
  snippet="fetchMovies"
  highlightPatterns={["withIndex"]}
/>

### 결과 가져오기 및 새 문서 추가

벡터 검색에서 정보를 반환하려면 액션(벡터 검색은 액션에서만 사용 가능하므로)과 데이터를 로드하기 위한 쿼리 또는 뮤테이션이 필요합니다.

위의 예는 데이터를 로드하고 액션에서 반환하기 위해 쿼리를 사용했습니다. 이것은 액션이므로 반환된 데이터는 반응형이 아닙니다. 대안은 액션에서 벡터 검색의 결과를 반환하고 데이터를 반응적으로 로드하는 별도의 쿼리를 사용하는 것입니다. 검색 결과는 반응적으로 업데이트되지 않지만 각 결과에 대한 데이터는 반응형일 것입니다.

[벡터 검색 데모 앱](https://github.com/get-convex/convex-demos/tree/main/vector-search)은 이 전략을 사용하여 반응형 "투표" 수가 있는 유사한 영화를 표시합니다.

## 제한사항

Convex는 현재 수백만 개의 벡터를 지원합니다. 이것은 진행 중인 프로젝트이며 Convex의 나머지 부분과 함께 이 서비스를 계속 확장할 것입니다.

벡터 인덱스는 다음을 가져야 합니다:

- 정확히 1개의 벡터 인덱스 필드.
  - 필드는 `v.array(v.float64())` 타입이어야 합니다(또는 가능한 타입 중 하나가 `v.array(v.float64())`인 유니온).
- 2에서 4096 사이의 값을 가진 정확히 1개의 차원 필드.
- 최대 16개의 필터 필드.

벡터 인덱스는 [테이블당 32개 인덱스 제한](/database/reading-data/indexes/indexes.md#limits)에 포함됩니다.
또한 테이블당 최대 4개의 벡터 인덱스를 가질 수 있습니다.

벡터 검색은 다음을 가질 수 있습니다:

- `vector` 필드에서 검색할 정확히 1개의 벡터
- 최대 64개의 필터 표현식
- 최대 256개의 요청된 결과(기본값 10).

액션이 벡터 검색을 수행한 다음 결과를 쿼리 또는 뮤테이션 함수에 전달하는 경우, 벡터 검색의 하나 이상의 결과가 삭제되거나 변경되었을 수 있습니다. 벡터 검색은 액션에서만 사용 가능하므로 결과를 기반으로 추가 트랜잭션 쿼리나 뮤테이션을 수행할 수 없습니다. 이것이 사용 사례에 중요한 경우, [Discord에서 알려주세요](https://convex.dev/community)!

벡터 인덱스에 지정된 크기와 필드에 벡터를 포함하는 문서만 인덱스에 포함되고 벡터 검색에서 반환됩니다.

제한사항에 대한 정보는 [여기](/production/state/limits.mdx)를 참조하세요.

## 향후 개발

우리는 항상 고객 피드백과 요청을 받아들입니다. Convex의 벡터 검색을 개선하기 위해 고려한 몇 가지 아이디어는 다음과 같습니다:

- 더 정교한 필터 및 필터 구문
- `vectorSearch` API에서 점수별 필터링
- 임베딩 생성을 위한 더 나은 지원

이러한 기능 중 하나라도 앱에 중요한 경우,
[Discord에서 알려주세요](https://convex.dev/community)!
